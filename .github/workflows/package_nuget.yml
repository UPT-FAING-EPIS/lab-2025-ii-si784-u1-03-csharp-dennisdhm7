name: Build, Test and Package NuGet

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.x'

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  build-test-package:
    runs-on: ubuntu-latest

    steps:
      # 🧩 1️⃣ Descargar código
      - name: Checkout repository
        uses: actions/checkout@v4

      # ⚙️ 2️⃣ Instalar .NET 9 SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # 📦 3️⃣ Restaurar dependencias
      - name: Restore dependencies
        run: dotnet restore Bank/Bank.sln

      # 🧱 4️⃣ Compilar en modo Release
      - name: Build solution
        run: dotnet build Bank/Bank.sln --configuration Release --no-restore

      # 🧪 5️⃣ Ejecutar pruebas unitarias con cobertura
      - name: Run Unit Tests with Coverage
        run: |
          mkdir -p Bank/Bank.WebApi.Tests/TestResults
          dotnet test Bank/Bank.WebApi.Tests/Bank.WebApi.Tests.csproj \
            --no-build \
            --configuration Release \
            --logger "trx;LogFileName=TestResults/test_results.trx" \
            /p:CollectCoverage=true \
            /p:CoverletOutputFormat=cobertura \
            /p:CoverletOutput=Bank/Bank.WebApi.Tests/TestResults/coverage

      # 🔍 6️⃣ SonarCloud (opcional para evitar error en la organización)
      - name: SonarCloud Analysis (opcional)
        continue-on-error: true
        run: |
          echo "🔸 Saltando análisis SonarCloud (no hay permisos en la organización UPT-FAING-EPIS)."
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 📦 7️⃣ Empaquetar NuGet (Bank.WebApi)
      - name: Pack NuGet Package
        run: |
          dotnet pack Bank/Bank.WebApi/Bank.WebApi.csproj -c Release -o out /p:GeneratePackageOnBuild=true

      # 🚀 8️⃣ Subir paquete como artefacto
      - name: Upload NuGet Package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: out/*.nupkg
