name: Build, Test and Package NuGet

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.x'

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  build-test-package:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§© 1ï¸âƒ£ Descargar cÃ³digo
      - name: Checkout repository
        uses: actions/checkout@v4

      # âš™ï¸ 2ï¸âƒ£ Instalar .NET 9 SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # ğŸ“¦ 3ï¸âƒ£ Restaurar dependencias
      - name: Restore dependencies
        run: dotnet restore Bank/Bank.sln

      # ğŸ§± 4ï¸âƒ£ Compilar en modo Release
      - name: Build solution
        run: dotnet build Bank/Bank.sln --configuration Release --no-restore

      # ğŸ§ª 5ï¸âƒ£ Ejecutar pruebas unitarias con cobertura
      - name: Run Unit Tests with Coverage
        run: |
          mkdir -p Bank/Bank.WebApi.Tests/TestResults
          dotnet test Bank/Bank.WebApi.Tests/Bank.WebApi.Tests.csproj \
            --no-build \
            --configuration Release \
            --logger "trx;LogFileName=TestResults/test_results.trx" \
            /p:CollectCoverage=true \
            /p:CoverletOutputFormat=cobertura \
            /p:CoverletOutput=Bank/Bank.WebApi.Tests/TestResults/coverage

      # ğŸ” 6ï¸âƒ£ SonarCloud (opcional para evitar error en la organizaciÃ³n)
      - name: SonarCloud Analysis (opcional)
        continue-on-error: true
        run: |
          echo "ğŸ”¸ Saltando anÃ¡lisis SonarCloud (no hay permisos en la organizaciÃ³n UPT-FAING-EPIS)."
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ“¦ 7ï¸âƒ£ Empaquetar NuGet (Bank.WebApi)
      - name: Pack NuGet Package
        run: |
          dotnet pack Bank/Bank.WebApi/Bank.WebApi.csproj -c Release -o out /p:GeneratePackageOnBuild=true

      # ğŸš€ 8ï¸âƒ£ Subir paquete como artefacto
      - name: Upload NuGet Package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: out/*.nupkg
